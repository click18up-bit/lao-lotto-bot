const express = require('express');
const mongoose = require('mongoose');
const TelegramBot = require('node-telegram-bot-api');
const cron = require('node-cron');
const axios = require('axios');
const cheerio = require('cheerio');

const app = express();
const PORT = process.env.PORT || 3000;

const BOT_TOKEN = process.env.BOT_TOKEN;
const MONGO_URI = process.env.MONGO_URI;
const TARGET_GROUP_ID = process.env.TARGET_GROUP_ID;
const ADMIN_ID = (process.env.ADMIN_ID || '1351945799').toString();

const bot = new TelegramBot(BOT_TOKEN, { polling: true });

/* ========== MongoDB Schema ========== */
const BetSchema = new mongoose.Schema({
  userId: String,       // Telegram user id (from.id)
  username: String,     // @username (optional)
  firstName: String,    // display name
  number: String,       // guessed number (2-4 digits as text)
  pos: String,          // "top" | "bottom" (only for 2 digits)
  round: String,        // draw date YYYY-MM-DD
  createdAt: { type: Date, default: Date.now }
});
const Bet = mongoose.model('Bet', BetSchema);

/* ========== Connect MongoDB ========== */
mongoose.connect(MONGO_URI)
  .then(() => console.log("‚úÖ MongoDB Connected"))
  .catch(err => console.error("‚ùå MongoDB Error:", err));

/* ========== Helpers ========== */
// Last Lao lotto date (Mon/Wed/Fri). If today < 20:30, use previous draw day.
function getLastLotteryDate() {
  const now = new Date();
  const lottoDays = [1, 3, 5]; // Mon=1, Wed=3, Fri=5
  let d = new Date(now);

  const beforeAnnouncement =
    now.getHours() < 20 || (now.getHours() === 20 && now.getMinutes() < 30);

  if (!lottoDays.includes(d.getDay()) || beforeAnnouncement) {
    do {
      d.setDate(d.getDate() - 1);
    } while (!lottoDays.includes(d.getDay()));
  }
  return d.toISOString().split("T")[0];
}
const cleanDigits = (s) => (s || '').replace(/[^\d]/g, '').trim();

/* ========== Scrape results from laosdev.net ========== */
/*
  ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å DOM ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤:
  - 4 ‡∏ï‡∏±‡∏ß:        .last4Prize
  - 3 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢:     .last3Prize
  - 2 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô:       .digit2_top
  - 2 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á:     .digit2_bottom
*/
async function fetchLatestResult() {
  try {
    const { data } = await axios.get('https://laosdev.net/', {
      headers: { 'User-Agent': 'Mozilla/5.0 (compatible; LottoBot/1.0)' }
    });
    const $ = cheerio.load(data);

    const digit4 = cleanDigits($(".last4Prize").first().text());
    const digit3 = cleanDigits($(".last3Prize").first().text());
    const digit2top = cleanDigits($(".digit2_top").first().text());
    const digit2bottom = cleanDigits($(".digit2_bottom").first().text());

    return {
      digit4: digit4 || "----",
      digit3: digit3 || "---",
      digit2top: digit2top || "--",
      digit2bottom: digit2bottom || "--"
    };
  } catch (err) {
    console.error("‚ùå Error fetching lotto:", err.message);
    return { digit4: "----", digit3: "---", digit2top: "--", digit2bottom: "--" };
  }
}

/* ========== Winners formatting ========== */
function formatWinners(arr, emoji) {
  if (!arr || arr.length === 0) return "‚ùå ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ñ‡∫ª‡∫ô‡∫ñ‡∫∑‡∫Å";
  // unique by userId to avoid duplicates
  const seen = new Set();
  const lines = [];
  for (const u of arr) {
    if (seen.has(u.userId)) continue;
    seen.add(u.userId);
    const label = u.username ? u.username : (u.firstName || u.userId);
    lines.push(`${emoji} ${label}`);
  }
  return lines.join("\n");
}

/* ========== Auto announce results ========== */
async function announceResult() {
  const res = await fetchLatestResult();
  const lastDate = getLastLotteryDate();
  const bets = await Bet.find({ round: lastDate });

  const winners4 = bets.filter(b => b.number === res.digit4);
  const winners3 = bets.filter(b => b.number === res.digit3);
  const winners2top = bets.filter(b => b.number === res.digit2top && b.pos === "top");
  const winners2bottom = bets.filter(b => b.number === res.digit2bottom && b.pos === "bottom");

  let msg =
    `üéâ ‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç‡∫•‡∫≤‡∫ß ‡∫á‡∫ß‡∫î ${lastDate}\n` +
    "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n" +
    `üèÜ 4 ‡∫ï‡∫ª‡∫ß: ${res.digit4}\n` + formatWinners(winners4, "üëë") + "\n\n" +
    `ü•á 3 ‡∫ï‡∫ª‡∫ß‡∫ó‡ªâ‡∫≤‡∫ç: ${res.digit3}\n` + formatWinners(winners3, "üèÖ") + "\n\n" +
    `‚¨ÜÔ∏è 2 ‡∫ï‡∫ª‡∫ß‡ªÄ‡∫ó‡∫¥‡∫á: ${res.digit2top}\n` + formatWinners(winners2top, "‚¨ÜÔ∏è") + "\n\n" +
    `‚¨áÔ∏è 2 ‡∫ï‡∫ª‡∫ß‡∫•‡∫∏‡ªà‡∫°: ${res.digit2bottom}\n` + formatWinners(winners2bottom, "‚¨áÔ∏è") + "\n" +
    "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n" +
    "üéä ‡∫Ç‡∫≠‡∫ö‡ªÉ‡∫à‡∫ó‡∫∏‡∫Å‡∫Ñ‡∫ª‡∫ô‡∫ó‡∫µ‡ªà‡∫Æ‡ªà‡∫ß‡∫°‡∫™‡∫ª‡∫ô‡∫∏‡∫Å!";

  if (TARGET_GROUP_ID) {
    bot.sendMessage(TARGET_GROUP_ID, msg);
  } else {
    console.warn("‚ö†Ô∏è TARGET_GROUP_ID not set; announcement not sent.");
  }
}

/* ========== Cron: Mon/Wed/Fri 20:30 server time ========== */
cron.schedule("30 13 * * 1,3,5", () => announceResult());

/* ========== Keyboards ========== */
function getKeyboard(isAdmin) {
  const base = [
    [{ text: "üé≤ ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÄ‡∫Å‡∫°‡∫ó‡∫≤‡∫ç‡ªÄ‡∫•‡∫Å" }],
    [{ text: "üîé ‡∫Å‡∫ß‡∫î‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç" }]
  ];
  if (isAdmin) base.push([{ text: "üîÑ Reset ‡∫Æ‡∫≠‡∫ö‡∫ô‡∫µ‡ªâ" }]);
  return { keyboard: base, resize_keyboard: true };
}

/* ========== /start ========== */
bot.onText(/\/start/, (msg) => {
  const isAdmin = msg.from && msg.from.id && msg.from.id.toString() === ADMIN_ID;
  bot.sendMessage(
    msg.chat.id,
    "üëã ‡∫™‡∫∞‡∫ö‡∫≤‡∫ç‡∫î‡∫µ! ‡∫Å‡∫ª‡∫î‡∫õ‡∫∏‡ªà‡∫°‡∫î‡ªâ‡∫≤‡∫ô‡∫•‡∫∏‡ªà‡∫°‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÄ‡∫Å‡∫° ‡∫´‡∫º‡∫∑ ‡∫Å‡∫ß‡∫î‡∫ú‡∫ª‡∫ô.",
    { reply_markup: getKeyboard(isAdmin) }
  );
});

/* ========== Message handler ========== */
bot.on('message', async (msg) => {
  const chatId = msg.chat.id;
  const text = (msg.text || '').trim();
  if (!text) return;

  // üé≤ Start round
  if (text === "üé≤ ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÄ‡∫Å‡∫°‡∫ó‡∫≤‡∫ç‡ªÄ‡∫•‡∫Å") {
    await Bet.deleteMany({ round: getLastLotteryDate() }); // reset current round
    const roundDate = getLastLotteryDate();
    bot.sendMessage(chatId,
      "üé≤ ‡∫Æ‡∫≠‡∫ö‡ªÉ‡ªù‡ªà‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫ï‡∫ª‡ªâ‡∫ô!\n" +
      "üìú ‡∫Å‡∫ª‡∫î‡∫Å‡∫≤:\n" +
      "1Ô∏è‚É£ ‡∫ó‡∫≤‡∫ç‡ªÑ‡∫î‡ªâ‡∫Ñ‡∫±‡ªâ‡∫á‡∫î‡∫Ω‡∫ß‡∫ï‡ªç‡ªà‡∫Æ‡∫≠‡∫ö\n" +
      "2Ô∏è‚É£ ‡∫û‡∫¥‡∫°‡ªÄ‡∫•‡∫Å 2 ‡∫´‡∫º‡∫∑ 4 ‡∫´‡∫º‡∫±‡∫Å\n" +
      "   - ‡∫ñ‡ªâ‡∫≤ 2 ‡∫´‡∫º‡∫±‡∫Å ‡∫à‡∫∞‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å ‚¨ÜÔ∏è ‡∫´‡∫º‡∫∑ ‚¨áÔ∏è\n" +
      "   - ‡∫ñ‡ªâ‡∫≤ 3-4 ‡∫´‡∫º‡∫±‡∫Å ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ó‡∫±‡∫ô‡∫ó‡∫µ\n\n" +
      "üèÜ ‡∫•‡∫≤‡∫á‡∫ß‡∫±‡∫ô:\n" +
      "üëë 4 ‡∫ï‡∫ª‡∫ß‡∫ï‡∫ª‡∫á ‚ûù 20,000 ‡ªÄ‡∫Ñ‡∫£‡∫î‡∫¥‡∫î\n" +
      "üèÖ 3 ‡∫ï‡∫ª‡∫ß‡∫ó‡ªâ‡∫≤‡∫ç ‚ûù 5,000 ‡ªÄ‡∫Ñ‡∫£‡∫î‡∫¥‡∫î\n" +
      "‚¨ÜÔ∏è 2 ‡∫ï‡∫ª‡∫ß‡ªÄ‡∫ó‡∫¥‡∫á ‚ûù 500 ‡ªÄ‡∫Ñ‡∫£‡∫î‡∫¥‡∫î\n" +
      "‚¨áÔ∏è 2 ‡∫ï‡∫ª‡∫ß‡∫•‡∫∏‡ªà‡∫° ‚ûù 500 ‡ªÄ‡∫Ñ‡∫£‡∫î‡∫¥‡∫î\n\n" +
      `üìÖ ‡∫õ‡∫∞‡∫Å‡∫≤‡∫î‡∫ú‡∫ª‡∫ô: ${roundDate} ‡ªÄ‡∫ß‡∫•‡∫≤ 20:30\n` +
      "üï£ ‡∫õ‡∫¥‡∫î‡∫Æ‡∫±‡∫ö: 20:25\n" +
      "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n" +
      "üéØ ‡∫û‡∫¥‡∫°‡ªÄ‡∫•‡∫Å 2-4 ‡∫´‡∫º‡∫±‡∫Å ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Æ‡ªà‡∫ß‡∫°‡∫™‡∫ª‡∫ô‡∫∏‡∫Å"
    );
    return;
  }

  // üîé Check latest result
  if (text === "üîé ‡∫Å‡∫ß‡∫î‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç") {
    const res = await fetchLatestResult();
    const lastDate = getLastLotteryDate();
    bot.sendMessage(chatId,
      "‚úÖ ‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç‡∫•‡ªà‡∫≤‡∫™‡∫∏‡∫î:\n" +
      `üëë 4 ‡∫ï‡∫ª‡∫ß: ${res.digit4}\n` +
      `üèÖ 3 ‡∫ï‡∫ª‡∫ß‡∫ó‡ªâ‡∫≤‡∫ç: ${res.digit3}\n` +
      `‚¨ÜÔ∏è 2 ‡∫ï‡∫ª‡∫ß‡ªÄ‡∫ó‡∫¥‡∫á: ${res.digit2top}\n` +
      `‚¨áÔ∏è 2 ‡∫ï‡∫ª‡∫ß‡∫•‡∫∏‡ªà‡∫°: ${res.digit2bottom}\n` +
      `üìÖ ‡∫ß‡∫±‡∫ô‡∫ó‡∫µ: ${lastDate}`
    );
    return;
  }

  // üîÑ Admin reset current round
  if (text === "üîÑ Reset ‡∫Æ‡∫≠‡∫ö‡∫ô‡∫µ‡ªâ") {
    const fromId = msg.from?.id?.toString();
    if (fromId !== ADMIN_ID) {
      bot.sendMessage(chatId, "‚ö†Ô∏è ‡∫Ñ‡∫≥‡∫™‡∫±‡ªà‡∫á‡∫ô‡∫µ‡ªâ‡ªÉ‡∫ä‡ªâ‡ªÑ‡∫î‡ªâ‡ªÄ‡∫â‡∫ª‡ªâ‡∫≤‡ªÅ‡∫≠‡∫±‡∫î‡∫°‡∫¥‡∫ô‡ªÄ‡∫ó‡∫ª‡ªà‡∫≤‡∫ô‡∫±‡ªâ‡∫ô");
      return;
    }
    const round = getLastLotteryDate();
    await Bet.deleteMany({ round });
    bot.sendMessage(chatId, `‚úÖ ‡∫•‡∫∂‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Å‡∫≤‡∫ô‡∫ó‡∫≤‡∫ç‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î‡∫Ç‡∫≠‡∫á‡∫Æ‡∫≠‡∫ö ${round} ‡ªÅ‡∫•‡ªâ‡∫ß`);
    return;
  }

  // üìù User typed 2‚Äì4 digits
  if (/^\d{2,4}$/.test(text)) {
    const userId = msg.from.id.toString();
    const round = getLastLotteryDate();
    const exist = await Bet.findOne({ userId, round });
    if (exist) {
      bot.sendMessage(chatId, "‚ö†Ô∏è ‡∫ó‡ªà‡∫≤‡∫ô‡ªÄ‡∫Ñ‡∫µ‡∫ç‡∫ó‡∫≤‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß‡ªÉ‡∫ô‡∫Æ‡∫≠‡∫ö‡∫ô‡∫µ‡ªâ");
      return;
    }

    const userData = {
      userId,
      username: msg.from.username ? `@${msg.from.username}` : null,
      firstName: msg.from.first_name
    };

    if (text.length === 2) {
      bot.sendMessage(chatId,
        `üìå ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫ï‡∫≥‡ªÅ‡ªú‡ªà‡∫á‡ªÉ‡∫´‡ªâ‡ªÄ‡∫•‡∫Å ${text}`,
        {
          reply_markup: {
            inline_keyboard: [
              [{ text: "‚¨ÜÔ∏è ‡ªÄ‡∫ó‡∫¥‡∫á", callback_data: `bet:${text}:top` }],
              [{ text: "‚¨áÔ∏è ‡∫•‡∫∏‡ªà‡∫°", callback_data: `bet:${text}:bottom` }]
            ]
          }
        }
      );
    } else {
      await Bet.create({ ...userData, number: text, round });
      bot.sendMessage(chatId, `‚úÖ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÄ‡∫•‡∫Å ${text} ‡∫Ç‡∫≠‡∫á‡∫ó‡ªà‡∫≤‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß`);
    }
    return;
  }
});

/* ========== Inline callback for 2-digit pos ========== */
bot.on('callback_query', async (query) => {
  const chatId = query.message.chat.id;
  const data = query.data || '';
  if (!data.startsWith("bet:")) return;

  const [, number, pos] = data.split(":");
  const userId = query.from.id.toString();
  const round = getLastLotteryDate();

  const exist = await Bet.findOne({ userId, round });
  if (exist) {
    bot.answerCallbackQuery(query.id, { text: "‚ö†Ô∏è ‡∫ó‡ªà‡∫≤‡∫ô‡ªÄ‡∫Ñ‡∫µ‡∫ç‡∫ó‡∫≤‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß‡ªÉ‡∫ô‡∫Æ‡∫≠‡∫ö‡∫ô‡∫µ‡ªâ", show_alert: true });
    return;
  }

  const userData = {
    userId,
    username: query.from.username ? `@${query.from.username}` : null,
    firstName: query.from.first_name
  };

  await Bet.create({ ...userData, number, pos, round });
  bot.answerCallbackQuery(query.id);
  bot.editMessageText(
    `‚úÖ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÄ‡∫•‡∫Å ${number} (${pos === "top" ? "‚¨ÜÔ∏è ‡ªÄ‡∫ó‡∫¥‡∫á" : "‚¨áÔ∏è ‡∫•‡∫∏‡ªà‡∫°"}) ‡∫Ç‡∫≠‡∫á‡∫ó‡ªà‡∫≤‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß`,
    { chat_id: chatId, message_id: query.message.message_id }
  );
});

/* ========== Health check ========== */
app.get('/', (req, res) => {
  res.send('Lao Lotto Bot is running üöÄ');
});

app.listen(PORT, () => {
  console.log(`üöÄ Server running on port ${PORT}`);
});
