const express = require('express');
const mongoose = require('mongoose');
const TelegramBot = require('node-telegram-bot-api');
const cron = require('node-cron');

const app = express();
const PORT = process.env.PORT || 3000;

const BOT_TOKEN = process.env.BOT_TOKEN;
const MONGO_URI = process.env.MONGO_URI;
const TARGET_GROUP_ID = process.env.TARGET_GROUP_ID;

// ===== Admin IDs =====
const SUPER_ADMIN_ID = "1351945799"; // Super Admin
const EDITOR_ADMIN_IDS = ["7211050914", "1662439252"]; // Editor Admins

function isSuperAdmin(userId) {
  return userId.toString() === SUPER_ADMIN_ID;
}
function isEditorAdmin(userId) {
  return EDITOR_ADMIN_IDS.includes(userId.toString());
}

const bot = new TelegramBot(BOT_TOKEN, { polling: true });

/* ================= Schema ================= */
const BetSchema = new mongoose.Schema({
  userId: String,
  name: String,
  username: String,
  number: String,
  pos: String, // 2top, 3top, 4direct
  round: String,
  createdAt: { type: Date, default: Date.now }
});
const Bet = mongoose.model('Bet', BetSchema);

const ResultSchema = new mongoose.Schema({
  date: String,
  digit4: String,
  digit3: String,
  digit2top: String,
  createdAt: { type: Date, default: Date.now }
});
const Result = mongoose.model('Result', ResultSchema);

/* ================= Connect DB ================= */
mongoose.connect(MONGO_URI)
  .then(() => console.log("‚úÖ MongoDB Connected"))
  .catch(err => console.error("‚ùå MongoDB Error:", err));

/* ================= Helper ================= */
function getLastLotteryDate() {
  const today = new Date();
  const lottoDays = [1, 3, 5]; // Mon, Wed, Fri
  let d = new Date(today);
  while (!lottoDays.includes(d.getDay()) || d > today) {
    d.setDate(d.getDate() - 1);
  }
  return d.toISOString().split("T")[0];
}

/* ================= Start ================= */
bot.onText(/\/start/, (msg) => {
  const userId = msg.from.id.toString();
  const isSuper = isSuperAdmin(userId);
  const isEditor = isEditorAdmin(userId);

  bot.sendMessage(
    msg.chat.id,
    "üëã ‡∫™‡∫∞‡∫ö‡∫≤‡∫ç‡∫î‡∫µ! ‡∫Å‡∫ª‡∫î‡∫õ‡∫∏‡ªà‡∫°‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÄ‡∫Å‡∫° ‡∫´‡∫º‡∫∑ ‡∫Å‡∫ß‡∫î‡∫ú‡∫ª‡∫ô.",
    {
      reply_markup: {
        keyboard: [
          [{ text: "üé≤ ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÄ‡∫Å‡∫°‡∫ó‡∫≤‡∫ç‡ªÄ‡∫•‡∫Å" }],
          [{ text: "üîé ‡∫Å‡∫ß‡∫î‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç" }],
          [{ text: "üìÖ ‡∫ú‡∫ª‡∫ô‡∫á‡∫ß‡∫î‡∫ó‡∫µ‡ªà‡∫ú‡ªà‡∫≤‡∫ô‡∫°‡∫≤" }],
          ...(isSuper || isEditor ? [[{ text: "‚úçÔ∏è ‡∫Å‡∫≠‡∫Å‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç" }]] : []),
          ...(isSuper ? [[{ text: "‚ôªÔ∏è Reset ‡∫Æ‡∫≠‡∫ö" }]] : [])
        ],
        resize_keyboard: true
      }
    }
  );
});

/* ================= Message Handler ================= */
bot.on('message', async (msg) => {
  const chatId = msg.chat.id;
  const text = (msg.text || "").trim();
  const userId = msg.from.id.toString();
  const isSuper = isSuperAdmin(userId);
  const isEditor = isEditorAdmin(userId);

  if (!text) return;

  // Start new round
  if (text === "üé≤ ‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡ªÄ‡∫Å‡∫°‡∫ó‡∫≤‡∫ç‡ªÄ‡∫•‡∫Å") {
    bot.sendMessage(chatId,
      "üé≤ ‡∫Æ‡∫≠‡∫ö‡ªÉ‡ªù‡ªà‡ªÄ‡∫•‡∫µ‡ªà‡∫°‡∫ï‡∫ª‡ªâ‡∫ô!\n" +
      "üìú ‡∫Å‡∫ª‡∫î‡∫Å‡∫≤:\n" +
      "1Ô∏è‚É£ ‡∫ó‡∫≤‡∫ç‡ªÑ‡∫î‡ªâ‡∫Ñ‡∫±‡ªâ‡∫á‡∫î‡∫Ω‡∫ß‡∫ï‡ªç‡ªà‡∫Æ‡∫≠‡∫ö\n" +
      "2Ô∏è‚É£ ‡∫û‡∫¥‡∫°‡ªÄ‡∫•‡∫Å 2, 3 ‡∫´‡∫º‡∫∑ 4 ‡∫ï‡∫ª‡∫ß\n\n" +
      "üèÜ ‡∫•‡∫≤‡∫á‡∫ß‡∫±‡∫ô:\n" +
      "üëë 4 ‡∫ï‡∫ª‡∫ß‡∫ï‡∫ª‡∫á ‚ûù 20,000 ‡ªÄ‡∫Ñ‡∫£‡∫î‡∫¥‡∫î\n" +
      "ü•á 3 ‡∫ï‡∫ª‡∫ß‡∫ö‡∫ô ‚ûù 5,000 ‡ªÄ‡∫Ñ‡∫£‡∫î‡∫¥‡∫î\n" +
      "‚¨ÜÔ∏è 2 ‡∫ï‡∫ª‡∫ß‡∫ö‡∫ô ‚ûù 500 ‡ªÄ‡∫Ñ‡∫£‡∫î‡∫¥‡∫î\n\n" +
      "üìÖ ‡∫õ‡∫∞‡∫Å‡∫≤‡∫î‡∫ú‡∫ª‡∫ô: 21:00 ‡ªÇ‡∫°‡∫á\n" +
      "üï£ ‡∫õ‡∫¥‡∫î‡∫Æ‡∫±‡∫ö: 20:25 ‡ªÇ‡∫°‡∫á\n" +
      "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n" +
      "üéØ ‡∫û‡∫¥‡∫°‡ªÄ‡∫•‡∫Å 2, 3 ‡∫´‡∫º‡∫∑ 4 ‡∫ï‡∫ª‡∫ß ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫Æ‡ªà‡∫ß‡∫°‡∫™‡∫ª‡∫ô‡∫∏‡∫Å"
    );
    return;
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  if (text === "üîé ‡∫Å‡∫ß‡∫î‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç") {
    const res = await Result.findOne().sort({ createdAt: -1 });
    if (!res) {
      bot.sendMessage(chatId, "‚ùå ‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç");
      return;
    }

    const winners4 = await Bet.find({ number: res.digit4, pos: "4direct", round: res.date });
    const winners3 = await Bet.find({ number: res.digit3, pos: "3top", round: res.date });
    const winners2 = await Bet.find({ number: res.digit2top, pos: "2top", round: res.date });

    let msgText =
      "‚úÖ ‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç‡∫•‡ªà‡∫≤‡∫™‡∫∏‡∫î\n" +
      "üìÖ ‡∫á‡∫ß‡∫î: " + res.date + "\n\n" +
      "üëë 4 ‡∫ï‡∫ª‡∫ß: " + (res.digit4 || "--") +
      (winners4.length ? "\n   üéØ ‡∫ñ‡∫∑‡∫Å: " + winners4.map(w => "üßë " + (w.username ? "@" + w.username : w.name)).join(", ") : "\n   ‚ùå ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ñ‡∫ª‡∫ô‡∫ñ‡∫∑‡∫Å") + "\n\n" +
      "ü•á 3 ‡∫ï‡∫ª‡∫ß: " + (res.digit3 || "--") +
      (winners3.length ? "\n   üéØ ‡∫ñ‡∫∑‡∫Å: " + winners3.map(w => "üßë " + (w.username ? "@" + w.username : w.name)).join(", ") : "\n   ‚ùå ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ñ‡∫ª‡∫ô‡∫ñ‡∫∑‡∫Å") + "\n\n" +
      "‚¨ÜÔ∏è 2 ‡∫ï‡∫ª‡∫ß: " + (res.digit2top || "--") +
      (winners2.length ? "\n   üéØ ‡∫ñ‡∫∑‡∫Å: " + winners2.map(w => "üßë " + (w.username ? "@" + w.username : w.name)).join(", ") : "\n   ‚ùå ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ñ‡∫ª‡∫ô‡∫ñ‡∫∑‡∫Å");

    bot.sendMessage(chatId, msgText);
    return;
  }

  // ‡∏ú‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
  if (text === "üìÖ ‡∫ú‡∫ª‡∫ô‡∫á‡∫ß‡∫î‡∫ó‡∫µ‡ªà‡∫ú‡ªà‡∫≤‡∫ô‡∫°‡∫≤") {
    const res = await Result.find().sort({ createdAt: -1 }).limit(2);
    if (res.length < 2) {
      bot.sendMessage(chatId, "‚ùå ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫ú‡∫ª‡∫ô‡∫á‡∫ß‡∫î‡∫Å‡ªà‡∫≠‡∫ô‡ªú‡ªâ‡∫≤");
      return;
    }
    const prev = res[1];
    let msgText =
      "üìÖ ‡∫ú‡∫ª‡∫ô‡∫á‡∫ß‡∫î‡∫ó‡∫µ‡ªà‡∫ú‡ªà‡∫≤‡∫ô‡∫°‡∫≤\n" +
      "üëë 4 ‡∫ï‡∫ª‡∫ß: " + (prev.digit4 || "--") + "\n" +
      "ü•á 3 ‡∫ï‡∫ª‡∫ß: " + (prev.digit3 || "--") + "\n" +
      "‚¨ÜÔ∏è 2 ‡∫ï‡∫ª‡∫ß: " + (prev.digit2top || "--") + "\n" +
      "üóì ‡∫ß‡∫±‡∫ô‡∫ó‡∫µ: " + prev.date;
    bot.sendMessage(chatId, msgText);
    return;
  }

  // ‡∏Å‡∏£‡∏≠‡∏Å‡∏ú‡∏• (Admin)
  if (text === "‚úçÔ∏è ‡∫Å‡∫≠‡∫Å‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç" && (isSuper || isEditor)) {
    bot.sendMessage(chatId, "‚úçÔ∏è ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫û‡∫¥‡∫°‡ªÄ‡∫•‡∫Å 2, 3 ‡∫´‡∫º‡∫∑ 4 ‡∫ï‡∫ª‡∫ß ‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ú‡∫ª‡∫ô");
    return;
  }

  // Reset ‡∏£‡∏≠‡∏ö (Super Admin)
  if (text === "‚ôªÔ∏è Reset ‡∫Æ‡∫≠‡∫ö" && isSuper) {
    await Bet.deleteMany({});
    await Result.deleteMany({});
    bot.sendMessage(chatId, "‚ôªÔ∏è ‡∫•‡ªâ‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫Å‡∫≤‡∫ô‡∫ó‡∫≤‡∫ç‡ªÅ‡∫•‡∫∞‡∫ú‡∫ª‡∫ô‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î‡ªÅ‡∫•‡ªâ‡∫ß");
    return;
  }

  // Admin input result
  if (/^\d{2,4}$/.test(text) && (isSuper || isEditor)) {
    const date = getLastLotteryDate();

    const exist = await Result.findOne({ date });
    if (exist) {
      bot.sendMessage(chatId, "‚ö†Ô∏è ‡∫°‡∫µ‡∫ú‡∫ª‡∫ô‡∫ñ‡∫∑‡∫Å‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß ‡∫ñ‡ªâ‡∫≤‡∫à‡∫∞‡ªÅ‡∫Å‡ªâ‡ªÉ‡∫´‡ªâ Reset ‡∫Å‡ªà‡∫≠‡∫ô");
      return;
    }

    let digit4 = null, digit3 = null, digit2top = null;

    if (text.length === 4) {
      digit4 = text;
      digit3 = text.slice(1);
      digit2top = text.slice(2);
    } else if (text.length === 3) {
      digit3 = text;
      digit2top = text.slice(1);
    } else if (text.length === 2) {
      digit2top = text;
    }

    await Result.create({ date, digit4, digit3, digit2top });

    bot.sendMessage(chatId,
      `‚úÖ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ú‡∫ª‡∫ô‡∫á‡∫ß‡∫î ${date} ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î\n` +
      (digit4 ? `üëë 4 ‡∫ï‡∫ª‡∫ß: ${digit4}\n` : "") +
      (digit3 ? `ü•á 3 ‡∫ï‡∫ª‡∫ß: ${digit3}\n` : "") +
      (digit2top ? `‚¨ÜÔ∏è 2 ‡∫ï‡∫ª‡∫ß: ${digit2top}\n` : "")
    );
    return;
  }

  // Player Bet
  if (/^\d{2,4}$/.test(text)) {
    const round = getLastLotteryDate();

    const exist = await Bet.findOne({ userId: chatId, round });
    if (exist) {
      bot.sendMessage(chatId, "‚ö†Ô∏è ‡∫ó‡ªà‡∫≤‡∫ô‡ªÄ‡∫Ñ‡∫µ‡∫ç‡∫ó‡∫≤‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß‡ªÉ‡∫ô‡∫Æ‡∫≠‡∫ö‡∫ô‡∫µ‡ªâ");
      return;
    }

    if (text.length === 2) {
      await Bet.create({ userId: chatId, name: msg.from.first_name, username: msg.from.username, number: text, pos: "2top", round });
      bot.sendMessage(chatId, `‚úÖ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÄ‡∫•‡∫Å 2 ‡∫ï‡∫ª‡∫ß: ${text}`);
    } else if (text.length === 3) {
      await Bet.create({ userId: chatId, name: msg.from.first_name, username: msg.from.username, number: text, pos: "3top", round });
      bot.sendMessage(chatId, `‚úÖ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÄ‡∫•‡∫Å 3 ‡∫ï‡∫ª‡∫ß: ${text}`);
    } else if (text.length === 4) {
      await Bet.create({ userId: chatId, name: msg.from.first_name, username: msg.from.username, number: text, pos: "4direct", round });
      bot.sendMessage(chatId, `‚úÖ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÄ‡∫•‡∫Å 4 ‡∫ï‡∫ª‡∫ß‡∫ï‡∫ª‡∫á: ${text}`);
    }
  } else if (/^\d+$/.test(text)) {
    bot.sendMessage(chatId, "‚ö†Ô∏è ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫û‡∫¥‡∫°‡ªÄ‡∫•‡∫Å 2, 3 ‡∫´‡∫º‡∫∑ 4 ‡∫ï‡∫ª‡∫ß‡ªÄ‡∫ó‡∫ª‡ªà‡∫≤‡∫ô‡∫±‡ªâ‡∫ô");
  }
});

/* ================= Cron ================= */
// ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Admin ‡∏ï‡∏≠‡∏ô 20:30
cron.schedule("30 13 * * 1,3,5", async () => {
  const res = await Result.findOne({ date: getLastLotteryDate() });
  if (!res) {
    bot.sendMessage(SUPER_ADMIN_ID, "‚è∞ ‡ªÄ‡∫ß‡∫•‡∫≤ 20:30 ‡ªÅ‡∫•‡ªâ‡∫ß ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫Å‡∫≠‡∫Å‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç");
    for (let id of EDITOR_ADMIN_IDS) {
      bot.sendMessage(id, "‚è∞ ‡ªÄ‡∫ß‡∫•‡∫≤ 20:30 ‡ªÅ‡∫•‡ªâ‡∫ß ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫Å‡∫≠‡∫Å‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç");
    }
  }
});

// ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•‡∏ï‡∏≠‡∏ô 21:00
cron.schedule("0 14 * * 1,3,5", async () => {
  const res = await Result.findOne({ date: getLastLotteryDate() });
  if (!res) {
    bot.sendMessage(TARGET_GROUP_ID, "‚ùå ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç‡∫ñ‡∫∑‡∫Å‡∫Å‡∫≠‡∫Å‡ªÉ‡∫ô‡∫á‡∫ß‡∫î‡∫ô‡∫µ‡ªâ");
    return;
  }

  const winners4 = await Bet.find({ number: res.digit4, pos: "4direct", round: res.date });
  const winners3 = await Bet.find({ number: res.digit3, pos: "3top", round: res.date });
  const winners2 = await Bet.find({ number: res.digit2top, pos: "2top", round: res.date });

  let msgText =
    "üéâ ‡∫ú‡∫ª‡∫ô‡∫´‡∫ß‡∫ç‡∫á‡∫ß‡∫î " + res.date + "\n" +
    "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n" +
    "üëë 4 ‡∫ï‡∫ª‡∫ß: " + (res.digit4 || "--") +
    (winners4.length ? "\n   üéØ ‡∫ñ‡∫∑‡∫Å: " + winners4.map(w => `üßë <a href="tg://user?id=${w.userId}">${w.name}</a>`).join(", ") : "\n   ‚ùå ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ñ‡∫ª‡∫ô‡∫ñ‡∫∑‡∫Å") + "\n\n" +
    "ü•á 3 ‡∫ï‡∫ª‡∫ß: " + (res.digit3 || "--") +
    (winners3.length ? "\n   üéØ ‡∫ñ‡∫∑‡∫Å: " + winners3.map(w => `üßë <a href="tg://user?id=${w.userId}">${w.name}</a>`).join(", ") : "\n   ‚ùå ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ñ‡∫ª‡∫ô‡∫ñ‡∫∑‡∫Å") + "\n\n" +
    "‚¨ÜÔ∏è 2 ‡∫ï‡∫ª‡∫ß: " + (res.digit2top || "--") +
    (winners2.length ? "\n   üéØ ‡∫ñ‡∫∑‡∫Å: " + winners2.map(w => `üßë <a href="tg://user?id=${w.userId}">${w.name}</a>`).join(", ") : "\n   ‚ùå ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ñ‡∫ª‡∫ô‡∫ñ‡∫∑‡∫Å") + "\n" +
    "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê";

  bot.sendMessage(TARGET_GROUP_ID, msgText, { parse_mode: "HTML" });
});

/* ================= Express Health ================= */
app.get('/', (req, res) => {
  res.send('Lao Lotto Bot is running üöÄ');
});

app.listen(PORT, () => {
  console.log(`üöÄ Server running on port ${PORT}`);
});
